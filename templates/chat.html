{% extends "base.html" %}

{% block title %}Колыбель - Чат{% endblock %}

{% block extra_head %}
<style>
    .chat-container {
        height: calc(100vh - 200px);
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .message {
        margin-bottom: 15px;
        animation: fadeIn 0.3s ease-in;
    }
    
    .message.user {
        text-align: right;
    }
    
    .message.assistant {
        text-align: left;
    }
    
    .message-bubble {
        display: inline-block;
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message.user .message-bubble {
        background: #007bff;
        color: white;
    }
    
    .message.assistant .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #dee2e6;
    }
    
    .message.system .message-bubble {
        background: #28a745;
        color: white;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .typing-indicator {
        display: none;
        text-align: left;
        margin-bottom: 15px;
    }
    
    .typing-indicator .message-bubble {
        background: #e9ecef;
        color: #6c757d;
    }
    
    .typing-dots {
        display: inline-block;
    }
    
    .typing-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #6c757d;
        margin: 0 2px;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .chat-input-container {
        background: white;
        border-radius: 10px;
        padding: 15px;
        border: 1px solid #dee2e6;
    }
    
    .quick-actions {
        margin-bottom: 15px;
    }
    
    .quick-action-btn {
        margin: 2px;
        font-size: 0.875rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> Диалог с Колыбелью
                </h5>
                <div>
                    <span id="connection-status" class="badge bg-success">
                        <i class="bi bi-circle-fill"></i> Подключено
                    </span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearChat()">
                        <i class="bi bi-trash"></i> Очистить
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message assistant">
                            <div class="message-bubble">
                                <i class="bi bi-cpu"></i> Привет! Я Колыбель, ваш интеллектуальный ассистент. 
                                Как дела? Чем могу помочь?
                            </div>
                            <div class="message-time">только что</div>
                        </div>
                    </div>
                    
                    <!-- Индикатор печати -->
                    <div class="typing-indicator" id="typing-indicator">
                        <div class="message-bubble">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <!-- Быстрые действия -->
                        <div class="quick-actions">
                            <button class="btn btn-sm btn-outline-primary quick-action-btn" onclick="insertQuickMessage('Создай RSS агента для мониторинга новостей')">
                                <i class="bi bi-robot"></i> Создать агента
                            </button>
                            <button class="btn btn-sm btn-outline-success quick-action-btn" onclick="insertQuickMessage('goal: Увеличить подписчиков канала до 1000')">
                                <i class="bi bi-target"></i> Добавить цель
                            </button>
                            <button class="btn btn-sm btn-outline-info quick-action-btn" onclick="insertQuickMessage('stats')">
                                <i class="bi bi-graph-up"></i> Статистика
                            </button>
                            <button class="btn btn-sm btn-outline-warning quick-action-btn" onclick="insertQuickMessage('audit')">
                                <i class="bi bi-list-check"></i> Аудит
                            </button>
                        </div>
                        
                        <!-- Поле ввода -->
                        <div class="input-group">
                            <textarea 
                                class="form-control" 
                                id="message-input" 
                                placeholder="Напишите сообщение..." 
                                rows="2"
                                style="resize: none;"
                            ></textarea>
                            <button class="btn btn-primary" type="button" onclick="sendMessage()">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                        
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-lightbulb"></i> 
                                Попробуйте: "создай агента", "goal: моя цель", "stats", "remind"
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Боковая панель -->
    <div class="col-lg-4">
        <!-- Быстрое создание агента -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-robot"></i> Быстрое создание агента
                </h6>
            </div>
            <div class="card-body">
                <form id="quick-agent-form">
                    <div class="mb-2">
                        <select class="form-select form-select-sm" id="agent-type">
                            <option value="rss_monitor">RSS Монитор</option>
                            <option value="content_generator">Генератор контента</option>
                            <option value="channel_manager">Менеджер канала</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control form-control-sm" id="agent-chat-id" placeholder="@channel или ID">
                    </div>
                    <div class="mb-2" id="agent-rss-group">
                        <input type="url" class="form-control form-control-sm" id="agent-rss-url" placeholder="RSS URL">
                    </div>
                    <div class="mb-2">
                        <input type="text" class="form-control form-control-sm" id="agent-style" placeholder="Стиль (опционально)">
                    </div>
                    <button type="button" class="btn btn-primary btn-sm w-100" onclick="createAgentFromSidebar()">
                        <i class="bi bi-plus"></i> Создать
                    </button>
                </form>
            </div>
        </div>
        
        <!-- История команд -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i> Последние команды
                </h6>
            </div>
            <div class="card-body">
                <div id="command-history">
                    <small class="text-muted">История команд появится здесь</small>
                </div>
            </div>
        </div>
        
        <!-- Шаблоны сообщений -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-chat-square-text"></i> Шаблоны
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-1">
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('Создай агента для мониторинга RSS ленты https://example.com/rss и публикации в канал @mychannel')">
                        RSS агент
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('goal: Создать успешный Telegram канал с 10000 подписчиков')">
                        Цель канала
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('Проанализируй эффективность моих агентов и предложи улучшения')">
                        Анализ агентов
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="insertTemplate('Создай контент-план для технологического канала на неделю')">
                        Контент-план
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let socket;
let messageHistory = [];

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    initializeSocket();
    setupMessageInput();
    loadCommandHistory();
});

function initializeSocket() {
    socket = io();
    
    socket.on('connect', function() {
        console.log('Подключено к серверу');
        updateConnectionStatus(true);
    });
    
    socket.on('disconnect', function() {
        console.log('Отключено от сервера');
        updateConnectionStatus(false);
    });
    
    socket.on('connected', function(data) {
        console.log('Сессия чата создана:', data.session_id);
    });
    
    socket.on('message_response', function(data) {
        hideTypingIndicator();
        
        // Добавляем ответ ассистента
        addMessage('assistant', data.assistant_message.content, data.assistant_message.type);
        
        // Сохраняем в историю
        messageHistory.push(data.user_message, data.assistant_message);
        updateCommandHistory(data.user_message.content);
    });
    
    socket.on('agent_created', function(data) {
        if (data.success) {
            addMessage('system', `✅ Агент создан успешно!\nID: ${data.agent_id}`, 'agent_created');
        } else {
            addMessage('system', `❌ Ошибка создания агента: ${data.error}`, 'error');
        }
    });
    
    socket.on('error', function(data) {
        hideTypingIndicator();
        addMessage('system', `❌ Ошибка: ${data.message}`, 'error');
    });
}

function setupMessageInput() {
    const messageInput = document.getElementById('message-input');
    
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Автофокус на поле ввода
    messageInput.focus();
}

function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Добавляем сообщение пользователя
    addMessage('user', message);
    
    // Показываем индикатор печати
    showTypingIndicator();
    
    // Отправляем сообщение на сервер
    socket.emit('send_message', { message: message });
    
    // Очищаем поле ввода
    messageInput.value = '';
    messageInput.focus();
}

function addMessage(role, content, type = 'text') {
    const messagesContainer = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}`;
    
    let iconClass = '';
    if (role === 'assistant') {
        iconClass = type === 'system' ? 'bi-gear' : 'bi-cpu';
    } else if (role === 'user') {
        iconClass = 'bi-person';
    } else if (role === 'system') {
        iconClass = 'bi-info-circle';
    }
    
    const icon = iconClass ? `<i class="${iconClass}"></i> ` : '';
    const formattedContent = formatMessageContent(content);
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${icon}${formattedContent}
        </div>
        <div class="message-time">${new Date().toLocaleTimeString()}</div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function formatMessageContent(content) {
    // Простое форматирование текста
    return content
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
}

function showTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'block';
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    document.getElementById('typing-indicator').style.display = 'none';
}

function updateConnectionStatus(connected) {
    const statusElement = document.getElementById('connection-status');
    if (connected) {
        statusElement.className = 'badge bg-success';
        statusElement.innerHTML = '<i class="bi bi-circle-fill"></i> Подключено';
    } else {
        statusElement.className = 'badge bg-danger';
        statusElement.innerHTML = '<i class="bi bi-circle-fill"></i> Отключено';
    }
}

function clearChat() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML = `
        <div class="message assistant">
            <div class="message-bubble">
                <i class="bi bi-cpu"></i> Чат очищен. Как дела? Чем могу помочь?
            </div>
            <div class="message-time">${new Date().toLocaleTimeString()}</div>
        </div>
    `;
    messageHistory = [];
}

function insertQuickMessage(message) {
    document.getElementById('message-input').value = message;
    document.getElementById('message-input').focus();
}

function insertTemplate(template) {
    document.getElementById('message-input').value = template;
    document.getElementById('message-input').focus();
}

function createAgentFromSidebar() {
    const type = document.getElementById('agent-type').value;
    const chatId = document.getElementById('agent-chat-id').value;
    const rssUrl = document.getElementById('agent-rss-url').value;
    const style = document.getElementById('agent-style').value;
    
    if (!chatId) {
        alert('Укажите ID канала или чата');
        return;
    }
    
    const agentData = {
        type: type,
        chat_id: chatId,
        style: style || 'информативный стиль'
    };
    
    if (type === 'rss_monitor' && rssUrl) {
        agentData.rss_url = rssUrl;
    }
    
    socket.emit('create_agent_from_chat', agentData);
    
    // Очищаем форму
    document.getElementById('quick-agent-form').reset();
}

function updateCommandHistory(command) {
    const historyContainer = document.getElementById('command-history');
    const commandHistory = JSON.parse(localStorage.getItem('commandHistory') || '[]');
    
    // Добавляем новую команду
    commandHistory.unshift({
        command: command,
        timestamp: new Date().toISOString()
    });
    
    // Оставляем только последние 10 команд
    commandHistory.splice(10);
    
    // Сохраняем в localStorage
    localStorage.setItem('commandHistory', JSON.stringify(commandHistory));
    
    // Обновляем отображение
    displayCommandHistory(commandHistory);
}

function loadCommandHistory() {
    const commandHistory = JSON.parse(localStorage.getItem('commandHistory') || '[]');
    displayCommandHistory(commandHistory);
}

function displayCommandHistory(history) {
    const historyContainer = document.getElementById('command-history');
    
    if (history.length === 0) {
        historyContainer.innerHTML = '<small class="text-muted">История команд появится здесь</small>';
        return;
    }
    
    let html = '';
    history.forEach((item, index) => {
        const shortCommand = item.command.length > 30 ? 
            item.command.substring(0, 30) + '...' : 
            item.command;
        
        html += `
            <div class="d-flex justify-content-between align-items-center mb-1">
                <small class="text-truncate" style="cursor: pointer;" onclick="insertQuickMessage('${item.command.replace(/'/g, '\\\'')}')" title="${item.command}">
                    ${shortCommand}
                </small>
                <small class="text-muted">${new Date(item.timestamp).toLocaleTimeString()}</small>
            </div>
        `;
    });
    
    historyContainer.innerHTML = html;
}

// Обработка изменения типа агента
document.addEventListener('DOMContentLoaded', function() {
    const agentTypeSelect = document.getElementById('agent-type');
    const rssGroup = document.getElementById('agent-rss-group');
    
    if (agentTypeSelect && rssGroup) {
        agentTypeSelect.addEventListener('change', function() {
            if (this.value === 'rss_monitor') {
                rssGroup.style.display = 'block';
            } else {
                rssGroup.style.display = 'none';
            }
        });
    }
});
</script>
{% endblock %}