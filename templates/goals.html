{% extends "base.html" %} {% block title %}–ö–æ–ª—ã–±–µ–ª—å - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–ª—è–º–∏{%
endblock %} {% block content %}
<div class="row">
  <div class="col-lg-8">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0"><i class="bi bi-target"></i> –ú–æ–∏ —Ü–µ–ª–∏</h5>
        <button
          class="btn btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#addGoalModal"
        >
          <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å
        </button>
      </div>
      <div class="card-body">
        <div id="goals-list">
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
            <p class="mt-2">–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–ª–µ–π...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-graph-up"></i> –ü—Ä–æ–≥—Ä–µ—Å—Å</h6>
      </div>
      <div class="card-body text-center">
        <div class="mb-3">
          <canvas id="goalsChart" width="200" height="200"></canvas>
        </div>
        <div class="row text-center">
          <div class="col-4">
            <div class="text-success">
              <strong id="completed-goals">0</strong>
              <br /><small>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</small>
            </div>
          </div>
          <div class="col-4">
            <div class="text-warning">
              <strong id="active-goals">0</strong>
              <br /><small>–ê–∫—Ç–∏–≤–Ω—ã—Ö</small>
            </div>
          </div>
          <div class="col-4">
            <div class="text-info">
              <strong id="total-goals">0</strong>
              <br /><small>–í—Å–µ–≥–æ</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h6 class="mb-0"><i class="bi bi-lightbulb"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h6>
      </div>
      <div class="card-body">
        <div id="recommendations">
          <p class="text-muted">
            –î–æ–±–∞–≤—å—Ç–µ —Ü–µ–ª–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏ -->
<div class="modal fade" id="addGoalModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ü–µ–ª—å
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="addGoalForm">
          <div class="mb-3">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–∏</label>
            <textarea
              class="form-control"
              name="text"
              rows="3"
              placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ü–µ–ª—å –ø–æ–¥—Ä–æ–±–Ω–æ..."
              required
            ></textarea>
            <div class="form-text">
              –ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã - —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ö–æ–ª—ã–±–µ–ª–∏ –ª—É—á—à–µ –ø–æ–º–æ—á—å –≤–∞–º
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select class="form-select" name="priority">
                  <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
                  <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                  <option value="low">–ù–∏–∑–∫–∏–π</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-select" name="category">
                  <option value="business">–ë–∏–∑–Ω–µ—Å</option>
                  <option value="personal">–õ–∏—á–Ω–æ–µ</option>
                  <option value="learning">–û–±—É—á–µ–Ω–∏–µ</option>
                  <option value="health">–ó–¥–æ—Ä–æ–≤—å–µ</option>
                  <option value="other">–î—Ä—É–≥–æ–µ</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">–î–µ–¥–ª–∞–π–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="date" class="form-control" name="deadline" />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button type="button" class="btn btn-primary" onclick="addGoal()">
          <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let goalsData = [];
  let goalsChart;

  document.addEventListener("DOMContentLoaded", function () {
    loadGoals();
    initChart();
  });

  function loadGoals() {
    fetch("/api/goals")
      .then((response) => response.json())
      .then((data) => {
        goalsData = data.goals || [];
        displayGoals(goalsData);
        updateStatistics(goalsData);
        updateChart(goalsData);
        generateRecommendations(goalsData);
      })
      .catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–ª–µ–π:", error);
        document.getElementById("goals-list").innerHTML =
          '<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–ª–µ–π</div>';
      });
  }

  function displayGoals(goals) {
    const goalsList = document.getElementById("goals-list");

    if (!goals || goals.length === 0) {
      goalsList.innerHTML = `
            <div class="text-center py-4">
                <i class="bi bi-target display-1 text-muted"></i>
                <h4 class="text-muted mt-3">–ù–µ—Ç —Ü–µ–ª–µ–π</h4>
                <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Ü–µ–ª—å, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –¥–æ—Å—Ç–∏–≥–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                    <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Ü–µ–ª—å
                </button>
            </div>
        `;
      return;
    }

    let html = "";
    goals.forEach((goal, index) => {
      const isCompleted = goal.completed;
      const cardClass = isCompleted ? "border-success" : "border-warning";
      const iconClass = isCompleted
        ? "bi-check-circle-fill text-success"
        : "bi-circle text-warning";

      html += `
            <div class="card mb-3 ${cardClass}">
                <div class="card-body">
                    <div class="d-flex align-items-start">
                        <div class="me-3 mt-1">
                            <i class="bi ${iconClass} fs-4" style="cursor: pointer;" onclick="toggleGoal(${index})"></i>
                        </div>
                        <div class="flex-grow-1">
                            <p class="mb-2 ${
                              isCompleted
                                ? "text-decoration-line-through text-muted"
                                : ""
                            }">${goal.text}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-secondary me-1">${
                                      goal.category || "–û–±—â–µ–µ"
                                    }</span>
                                    <span class="badge bg-${getPriorityColor(
                                      goal.priority || "medium"
                                    )}">${getPriorityLabel(
        goal.priority || "medium"
      )}</span>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editGoal(${index})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteGoal(${index})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    goalsList.innerHTML = html;
  }

  function updateStatistics(goals) {
    const completed = goals.filter((g) => g.completed).length;
    const active = goals.filter((g) => !g.completed).length;
    const total = goals.length;

    document.getElementById("completed-goals").textContent = completed;
    document.getElementById("active-goals").textContent = active;
    document.getElementById("total-goals").textContent = total;
  }

  function initChart() {
    const ctx = document.getElementById("goalsChart").getContext("2d");
    goalsChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["–í—ã–ø–æ–ª–Ω–µ–Ω–æ", "–ê–∫—Ç–∏–≤–Ω—ã—Ö"],
        datasets: [
          {
            data: [0, 0],
            backgroundColor: ["#28a745", "#ffc107"],
            borderWidth: 0,
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
        },
      },
    });
  }

  function updateChart(goals) {
    const completed = goals.filter((g) => g.completed).length;
    const active = goals.filter((g) => !g.completed).length;

    goalsChart.data.datasets[0].data = [completed, active];
    goalsChart.update();
  }

  function generateRecommendations(goals) {
    const recommendationsDiv = document.getElementById("recommendations");

    if (!goals || goals.length === 0) {
      recommendationsDiv.innerHTML =
        '<p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ —Ü–µ–ª–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</p>';
      return;
    }

    const activeGoals = goals.filter((g) => !g.completed);
    const completedGoals = goals.filter((g) => g.completed);

    let recommendations = [];

    if (activeGoals.length === 0) {
      recommendations.push(
        "üéâ –í—Å–µ —Ü–µ–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã! –í—Ä–µ–º—è —Å—Ç–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∞–º–±–∏—Ü–∏–æ–∑–Ω—ã–µ –∑–∞–¥–∞—á–∏."
      );
    } else if (activeGoals.length > 5) {
      recommendations.push(
        "üìù –£ –≤–∞—Å –º–Ω–æ–≥–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ 3-5 —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö."
      );
    }

    if (completedGoals.length > 0) {
      recommendations.push("‚úÖ –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ.");
    }

    const businessGoals = activeGoals.filter((g) => g.category === "business");
    if (businessGoals.length > 0) {
      recommendations.push(
        "üíº –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤."
      );
    }

    if (recommendations.length === 0) {
      recommendations.push(
        "üéØ –°—Ç–∞–≤—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ, –∏–∑–º–µ—Ä–∏–º—ã–µ —Ü–µ–ª–∏ —Å –¥–µ–¥–ª–∞–π–Ω–∞–º–∏."
      );
    }

    let html = '<ul class="list-unstyled">';
    recommendations.forEach((rec) => {
      html += `<li class="mb-2"><small>${rec}</small></li>`;
    });
    html += "</ul>";

    recommendationsDiv.innerHTML = html;
  }

  function addGoal() {
    const form = document.getElementById("addGoalForm");
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    fetch("/api/goals", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((result) => {
        if (result.success) {
          showNotification("–¶–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!", "success");
          bootstrap.Modal.getInstance(
            document.getElementById("addGoalModal")
          ).hide();
          form.reset();
          loadGoals();
        } else {
          showNotification("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏: " + result.error, "danger");
        }
      })
      .catch((error) => {
        console.error("–û—à–∏–±–∫–∞:", error);
        showNotification("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ü–µ–ª–∏", "danger");
      });
  }

  function toggleGoal(index) {
    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Ü–µ–ª–∏
    showNotification("–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ", "info");
  }

  function editGoal(index) {
    showNotification("–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ", "info");
  }

  function deleteGoal(index) {
    if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ü–µ–ª—å?")) {
      showNotification("–§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ", "info");
    }
  }

  function getPriorityColor(priority) {
    const colors = {
      high: "danger",
      medium: "warning",
      low: "info",
    };
    return colors[priority] || "secondary";
  }

  function getPriorityLabel(priority) {
    const labels = {
      high: "–í—ã—Å–æ–∫–∏–π",
      medium: "–°—Ä–µ–¥–Ω–∏–π",
      low: "–ù–∏–∑–∫–∏–π",
    };
    return labels[priority] || priority;
  }

  function showNotification(message, type = "info") {
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }
</script>
{% endblock %}
